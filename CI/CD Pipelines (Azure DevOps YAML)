# .azure-pipelines/ci-cd.yml
trigger:
  branches:
    include:
      - main

stages:
  - stage: Build
    jobs:
      - job: BuildFunctionApp
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.11'
          - script: |
              pip install -r requirements.txt
              pytest tests/
          - task: PublishBuildArtifacts@1

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: DeployInfra
        steps:
          - task: TerraformInstaller@1
          - script: |
              terraform init
              terraform apply -auto-approve

      - job: DeployFunctionApp
        steps:
          - task: AzureFunctionApp@1
            inputs:
              appType: functionAppLinux
              appName: billing-archiver-func
              package: $(Pipeline.Workspace)/drop/*.zip
